# ç™»å½•ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

AIèµ„è®¯å¾®ä¿¡å…¬ä¼—å·æ™ºèƒ½ä½“ç°åœ¨æ”¯æŒå®Œæ•´çš„ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†ç³»ç»Ÿï¼Œç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·æ‰èƒ½è®¿é—®ç³»ç»ŸåŠŸèƒ½ã€‚

**ä½œè€…**: zengzhengtx

## åŠŸèƒ½ç‰¹æ€§

### ğŸ” ç”¨æˆ·è®¤è¯
- ç”¨æˆ·å/å¯†ç ç™»å½•
- å®‰å…¨çš„å¯†ç å“ˆå¸Œå­˜å‚¨
- ä¼šè¯ç®¡ç†å’Œè¶…æ—¶æ§åˆ¶
- è‡ªåŠ¨ç™»å‡ºåŠŸèƒ½

### ğŸ‘¥ ç”¨æˆ·ç®¡ç†
- å¤šç”¨æˆ·æ”¯æŒ
- è§’è‰²æƒé™ç®¡ç†ï¼ˆadmin/userï¼‰
- ç”¨æˆ·æ·»åŠ å’Œåˆ é™¤
- å¯†ç ä¿®æ”¹åŠŸèƒ½

### ğŸ›¡ï¸å®‰å…¨ç‰¹æ€§
- å¯†ç å“ˆå¸ŒåŠ å¯†å­˜å‚¨
- ä¼šè¯tokenå®‰å…¨ç®¡ç†
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯
- ç™»å½•å¤±è´¥æ—¥å¿—è®°å½•

## å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨å¸¦è®¤è¯çš„Webç•Œé¢

```bash
python app_with_auth.py
```

é»˜è®¤è®¿é—®åœ°å€ï¼šhttp://127.0.0.1:7862

### 2. é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·

- **ç”¨æˆ·å**: `admin`
- **å¯†ç **: `admin123`

âš ï¸ **é‡è¦**: é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç ï¼

### 3. ç™»å½•æµç¨‹

1. æ‰“å¼€Webç•Œé¢
2. è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
3. ç‚¹å‡»"ç™»å½•"æŒ‰é’®
4. æˆåŠŸåè‡ªåŠ¨è·³è½¬åˆ°ä¸»ç•Œé¢

## ç”¨æˆ·ç®¡ç†

### æ·»åŠ æ–°ç”¨æˆ·

1. ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•
2. è¿›å…¥"ç”¨æˆ·ç®¡ç†"æ ‡ç­¾é¡µ
3. å¡«å†™æ–°ç”¨æˆ·ä¿¡æ¯ï¼š
   - ç”¨æˆ·å
   - å¯†ç 
   - è§’è‰²ï¼ˆuser/adminï¼‰
4. ç‚¹å‡»"æ·»åŠ ç”¨æˆ·"

### ä¿®æ”¹å¯†ç 

#### æ–¹æ³•1ï¼šé€šè¿‡Webç•Œé¢
1. ç™»å½•ç³»ç»Ÿ
2. è¿›å…¥"ç”¨æˆ·ç®¡ç†"æ ‡ç­¾é¡µ
3. åœ¨"ä¿®æ”¹å¯†ç "éƒ¨åˆ†å¡«å†™ä¿¡æ¯
4. ç‚¹å‡»"ä¿®æ”¹å¯†ç "

#### æ–¹æ³•2ï¼šé€šè¿‡ä»£ç 
```python
from src.auth.authentication import UserManager

user_manager = UserManager()
success = user_manager.change_password("username", "old_password", "new_password")
```

### æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨

1. è¿›å…¥"ç”¨æˆ·ç®¡ç†"æ ‡ç­¾é¡µ
2. ç‚¹å‡»"åˆ·æ–°ç”¨æˆ·åˆ—è¡¨"
3. æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„ä¿¡æ¯ï¼š
   - ç”¨æˆ·å
   - è§’è‰²
   - åˆ›å»ºæ—¶é—´
   - æœ€åç™»å½•æ—¶é—´

## æƒé™ç®¡ç†

### è§’è‰²è¯´æ˜

#### Adminï¼ˆç®¡ç†å‘˜ï¼‰
- è®¿é—®æ‰€æœ‰åŠŸèƒ½
- ç”¨æˆ·ç®¡ç†æƒé™
- ç³»ç»Ÿé…ç½®æƒé™
- æ•°æ®åº“ç®¡ç†æƒé™

#### Userï¼ˆæ™®é€šç”¨æˆ·ï¼‰
- è®¿é—®åŸºæœ¬åŠŸèƒ½
- æ–‡ç« æ ¼å¼åŒ–
- å†…å®¹ç­›é€‰
- æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

### æƒé™æ§åˆ¶

ç³»ç»Ÿé€šè¿‡ä¼šè¯éªŒè¯å®ç°æƒé™æ§åˆ¶ï¼š

```python
# éªŒè¯ç”¨æˆ·ä¼šè¯
valid, session_info = user_manager.validate_session(session_token)
if valid:
    user_role = session_info['role']
    # æ ¹æ®è§’è‰²æ§åˆ¶è®¿é—®æƒé™
```

## å®‰å…¨é…ç½®

### ä¼šè¯è¶…æ—¶

é»˜è®¤ä¼šè¯è¶…æ—¶æ—¶é—´ï¼š1å°æ—¶ï¼ˆ3600ç§’ï¼‰

å¯ä»¥åœ¨ `UserManager` åˆå§‹åŒ–æ—¶ä¿®æ”¹ï¼š

```python
user_manager = UserManager()
user_manager.session_timeout = 7200  # 2å°æ—¶
```

### å¯†ç å®‰å…¨

- ä½¿ç”¨SHA-256å“ˆå¸Œç®—æ³•
- æ·»åŠ å›ºå®šç›å€¼é˜²æ­¢å½©è™¹è¡¨æ”»å‡»
- å»ºè®®ä½¿ç”¨å¼ºå¯†ç ï¼ˆ8ä½ä»¥ä¸Šï¼ŒåŒ…å«å­—æ¯æ•°å­—ç‰¹æ®Šå­—ç¬¦ï¼‰

### æ•°æ®å­˜å‚¨

ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨ `data/users.json` æ–‡ä»¶ä¸­ï¼š

```json
{
  "admin": {
    "password_hash": "hashed_password",
    "role": "admin",
    "created_at": "2025-01-16T10:30:00",
    "last_login": "2025-01-16T11:00:00"
  }
}
```

## å‘½ä»¤è¡Œå·¥å…·

### æ¼”ç¤ºç™»å½•ç³»ç»Ÿ

```bash
python demo_login.py
```

è¿™ä¸ªè„šæœ¬ä¼šæ¼”ç¤ºï¼š
- ç”¨æˆ·è®¤è¯åŠŸèƒ½
- ä¼šè¯ç®¡ç†
- ç”¨æˆ·æ·»åŠ 
- å¯†ç ä¿®æ”¹

### å¯åŠ¨ä¸åŒç‰ˆæœ¬çš„åº”ç”¨

```bash
# å¸¦è®¤è¯çš„å®Œæ•´ç‰ˆæœ¬
python app_with_auth.py

# ç®€åŒ–ç‰ˆæœ¬ï¼ˆæ— è®¤è¯ï¼‰
python simple_web_fixed.py

# ç¨³å®šæ¼”ç¤ºç‰ˆæœ¬
python stable_demo.py
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: å¿˜è®°ç®¡ç†å‘˜å¯†ç æ€ä¹ˆåŠï¼Ÿ**
A: åˆ é™¤ `data/users.json` æ–‡ä»¶ï¼Œé‡å¯åº”ç”¨ä¼šè‡ªåŠ¨åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·ã€‚

**Q: ç™»å½•åé¡µé¢æ²¡æœ‰è·³è½¬ï¼Ÿ**
A: æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰JavaScripté”™è¯¯ï¼Œå°è¯•åˆ·æ–°é¡µé¢ã€‚

**Q: ä¼šè¯ç»å¸¸è¶…æ—¶ï¼Ÿ**
A: å¯ä»¥å¢åŠ  `session_timeout` å€¼ï¼Œæˆ–è€…å®ç°è‡ªåŠ¨ç»­æœŸåŠŸèƒ½ã€‚

**Q: å¦‚ä½•å¤‡ä»½ç”¨æˆ·æ•°æ®ï¼Ÿ**
A: å¤‡ä»½ `data/users.json` æ–‡ä»¶å³å¯ã€‚

### æ—¥å¿—æŸ¥çœ‹

ç³»ç»Ÿæ—¥å¿—ä¿å­˜åœ¨ `logs/app.log`ï¼ŒåŒ…å«ï¼š
- ç”¨æˆ·ç™»å½•/ç™»å‡ºè®°å½•
- è®¤è¯å¤±è´¥è®°å½•
- ä¼šè¯ç®¡ç†æ“ä½œ
- é”™è¯¯ä¿¡æ¯

```bash
# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
tail -f logs/app.log

# æœç´¢ç™»å½•ç›¸å…³æ—¥å¿—
grep "ç™»å½•" logs/app.log
```

## å¼€å‘æ‰©å±•

### æ·»åŠ æ–°çš„è®¤è¯æ–¹å¼

å¯ä»¥æ‰©å±• `UserManager` ç±»æ”¯æŒå…¶ä»–è®¤è¯æ–¹å¼ï¼š

```python
class UserManager:
    def authenticate_with_token(self, api_token):
        # å®ç°API tokenè®¤è¯
        pass
    
    def authenticate_with_oauth(self, oauth_token):
        # å®ç°OAuthè®¤è¯
        pass
```

### è‡ªå®šä¹‰æƒé™æ£€æŸ¥

```python
def require_admin(func):
    """è£…é¥°å™¨ï¼šè¦æ±‚ç®¡ç†å‘˜æƒé™"""
    def wrapper(session_token, *args, **kwargs):
        valid, session_info = user_manager.validate_session(session_token)
        if not valid or session_info['role'] != 'admin':
            raise PermissionError("éœ€è¦ç®¡ç†å‘˜æƒé™")
        return func(*args, **kwargs)
    return wrapper
```

### é›†æˆå¤–éƒ¨è®¤è¯ç³»ç»Ÿ

å¯ä»¥ä¿®æ”¹ `authenticate` æ–¹æ³•é›†æˆLDAPã€OAuthç­‰å¤–éƒ¨è®¤è¯ï¼š

```python
def authenticate(self, username, password):
    # å…ˆå°è¯•æœ¬åœ°è®¤è¯
    if self._local_authenticate(username, password):
        return True, self._create_session(username)
    
    # å†å°è¯•LDAPè®¤è¯
    if self._ldap_authenticate(username, password):
        return True, self._create_session(username)
    
    return False, None
```

## æœ€ä½³å®è·µ

1. **å®šæœŸæ›´æ”¹å¯†ç **ï¼šå»ºè®®æ¯3ä¸ªæœˆæ›´æ¢ä¸€æ¬¡å¯†ç 
2. **ä½¿ç”¨å¼ºå¯†ç **ï¼šè‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
3. **åŠæ—¶ç™»å‡º**ï¼šä½¿ç”¨å®Œæ¯•ååŠæ—¶ç™»å‡ºç³»ç»Ÿ
4. **ç›‘æ§æ—¥å¿—**ï¼šå®šæœŸæ£€æŸ¥ç™»å½•æ—¥å¿—ï¼Œå‘ç°å¼‚å¸¸åŠæ—¶å¤„ç†
5. **å¤‡ä»½æ•°æ®**ï¼šå®šæœŸå¤‡ä»½ç”¨æˆ·æ•°æ®å’Œé…ç½®æ–‡ä»¶

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ï¼š
- GitHub: [@zengzhengtx](https://github.com/zengzhengtx)
- é¡¹ç›®åœ°å€: [https://github.com/zengzhengtx/wechatAgent](https://github.com/zengzhengtx/wechatAgent)
